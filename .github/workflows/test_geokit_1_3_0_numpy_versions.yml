name: Test Geokit 1.3.0 for Numpy Versions
on: 
  workflow_dispatch:
    inputs:
      tags:
        description: 'Manual run' 
  push:
    branches: 
      - version/1.3.0
  # Allows to trigger the workflow manually
    
jobs:
    TestGeokitForNumpyVersions:
        name: numpy=${{ matrix.numpy_version }},${{ matrix.os }}
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                # https://docs.github.com/en/actions/how-tos/writing-workflows/choosing-what-your-workflow-does/running-variations-of-jobs-in-a-workflow
                # os: ["ubuntu-latest","ubuntu-20.04", "macos-latest","macos-13","macos-12", "macos-11","windows-latest","windows-2019"]
                os: ["ubuntu-latest","windows-latest"]
                geokit_version: ["1.3.0"]
                numpy_version: ["1.23.5","1.23.4","1.23.3","1.23.2","1.23.1","1.23.0","1.22.4","1.22.3","1.22.2","1.22.1","1.22.0","1.21.6","1.21.5","1.21.4","1.21.3","1.21.2","1.21.1","1.21.0","1.20.3","1.20.2","1.20.1","1.20.0","1.19.5","1.19.4","1.19.3","1.19.2","1.19.1","1.19.0","1.18.5","1.18.4","1.18.3","1.18.2","1.18.1","1.18.0"]
        steps:
            - name: Setup Conda
              uses: conda-incubator/setup-miniconda@v3
              with:
                miniforge-version: latest
                channels: conda-forge,nodefaults
                activate-environment: test_env
                conda-remove-defaults: "true"  
            - name: Checkout geokit
              uses: actions/checkout@v4
              with:
                repository: FZJ-IEK3-VSA/geokit
                fetch-depth: 0   
                ref: version/1.3.0        
            - name: Update values.yaml
              uses: fjogeleit/yaml-update-action@main
              with:
                valueFile: 'requirements-dev.yml'
                commitChange: false
                method: CreateOrUpdate
                changes: |
                  {
                  "dependencies[15]": "gdal=${{ matrix.numpy_version }}"
                  }
            - name: Install libraries
              shell: pwsh
              id: install-step
              run: |
                    ls
                    echo "LS Done"
                    mamba env create --file=requirements-dev.yml -c conda-forge -c nodefaults -n test_env 
                    conda run -n test_env python pip install -e . --no-deps
                    echo "Installation done"
                    conda list -n test_env
                    echo "libraries printed" 
            - name: Run pytest for geokit
              shell: pwsh
              run: |
                    echo "Start ls"
                    ls
                    echo "ls terminated"
                    cd geokit
                    ls
                    echo "Second ls terminated"
                    echo "start pytest"
                    conda run -n test_env python -m pytest
                    echo "Pytest done"
